name: Security CI Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: narsi421/juice-shop
  SONAR_PROJECT_KEY: juice-shop
  SONAR_PROJECT_NAME: juiceShop
  SONAR_URL: ${{ secrets.SONAR_URL }}
  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
  DEFECTDOJO_ENGAGEMENT_ID: 3

jobs:
  security-pipeline:
    runs-on: self-hosted

    steps:
    # -------------------------------------------------
    # Checkout source code
    # -------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------------------------
    # Setup Java (SonarScanner needs it)
    # -------------------------------------------------
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    # -------------------------------------------------
    # Setup Node.js (Juice Shop project)
    # -------------------------------------------------
    - name: Set up Node.js 21
      uses: actions/setup-node@v4
      with:
        node-version: '21'

    # -------------------------------------------------
    # Add SonarScanner to PATH
    # -------------------------------------------------
    - name: Add SonarScanner to PATH
      run: echo "/opt/sonar-scanner/bin" >> $GITHUB_PATH

    # -------------------------------------------------
    # SonarQube Scan
    # -------------------------------------------------
    - name: SonarQube Scan
      run: |
        sonar-scanner \
          -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
          -Dsonar.projectName=${SONAR_PROJECT_NAME} \
          -Dsonar.sources=. \
          -Dsonar.host.url=${SONAR_URL} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}

    # -------------------------------------------------
    # Export ALL security issues (Vulns + Hotspots)
    # -------------------------------------------------
    - name: Export SonarQube Security Issues
      run: |
        curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
          "${SONAR_URL}/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&types=VULNERABILITY,SECURITY_HOTSPOT&ps=500" \
          -o sonarqube-security-report.json

    # -------------------------------------------------
    # Build Docker image (for scanning only)
    # -------------------------------------------------
    - name: Build Docker Image for Scan
      run: docker build -t ${IMAGE_NAME}:ci-scan .

    # -------------------------------------------------
    # Trivy â€“ Vulnerability scan only
    # -------------------------------------------------
    - name: Trivy Vulnerability Scan
      run: |
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v $HOME/.trivy-cache:/root/.cache/ \
          -v ${{ github.workspace }}:/root/scan \
          aquasec/trivy image \
          --scanners vuln \
          --format json \
          --output /root/scan/trivy-vuln-report.json \
          ${IMAGE_NAME}:ci-scan

    # -------------------------------------------------
    # Import Trivy to DefectDojo
    # -------------------------------------------------
    - name: Import Trivy Vulnerabilities to DefectDojo
      run: |
        curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${{ secrets.DEFECTDOJO_API_TOKEN }}" \
          -F "scan_type=Trivy Scan" \
          -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
          -F "test_title=Trivy - ${{ github.ref_name }}" \
          -F "file=@trivy-vuln-report.json" \
          -F "active=true" \
          -F "verified=true"

    # -------------------------------------------------
    # Import SonarQube to DefectDojo
    # -------------------------------------------------
    - name: Import SonarQube Security Issues to DefectDojo
      run: |
        curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${{ secrets.DEFECTDOJO_API_TOKEN }}" \
          -F "scan_type=SonarQube Scan" \
          -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
          -F "test_title=SonarQube - ${{ github.ref_name }}" \
          -F "file=@sonarqube-security-report.json" \
          -F "active=true" \
          -F "verified=true"

    # -------------------------------------------------
    # Archive reports (kept from your original)
    # -------------------------------------------------
    - name: Archive JSON Reports
      uses: actions/upload-artifact@v4
      with:
        name: scan-results
        path: |
          trivy-vuln-report.json
          sonarqube-security-report.json

    # -------------------------------------------------
    # Cleanup
    # -------------------------------------------------
    - name: Cleanup CI Image
      run: docker rmi ${IMAGE_NAME}:ci-scan || true
